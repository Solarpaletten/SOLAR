# Отчет о проверке бэкенд-компонентов модуля продаж

**Дата:** 09.05.2025  
**Автор:** Дженни (Frontend Junior)

## 1. Обзор структуры бэкенд-компонентов продаж

### 1.1 API-маршруты
Маршруты для модуля продаж определены в файле `/var/www/SOLAR/solar/s/b/src/routes/salesRoutes.js`. Основные эндпоинты:

- `GET /api/sales` - получение списка продаж
- `GET /api/sales/:id` - получение информации о конкретной продаже
- `POST /api/sales` - создание новой продажи
- `PUT /api/sales/:id` - обновление информации о продаже
- `DELETE /api/sales/:id` - удаление продажи

Дополнительные маршруты для экспорта:
- `GET /api/sales/:id/export/pdf` - экспорт продажи в PDF
- `GET /api/sales/:id/export/excel` - экспорт продажи в Excel
- `GET /api/sales/:id/export/word` - экспорт продажи в Word

Все маршруты защищены middleware аутентификации `auth`.

### 1.2 Контроллеры
Логика обработки запросов разделена на два контроллера:

1. **salesController.js** - содержит основные CRUD-операции:
   - `getAllSales` - получение списка продаж
   - `getSaleById` - получение одной продажи по ID
   - `createSale` - создание новой продажи
   - `updateSale` - обновление существующей продажи
   - `deleteSale` - удаление продажи

2. **salesExportController.js** - отвечает за экспорт продаж в различные форматы:
   - `exportSaleToPdf` - экспорт в PDF
   - `exportSaleToExcel` - экспорт в Excel
   - `exportSaleToWord` - экспорт в Word

### 1.3 Взаимодействие с приложением
Маршруты продаж подключены к основному приложению в файле `app.js` через роутер:
```javascript
apiRouter.use('/sales', require('./routes/salesRoutes'));
```

## 2. Модель данных для продаж

### 2.1 Схема Prisma
В файле `/var/www/SOLAR/solar/s/b/prisma/schema.prisma` определена модель данных для продаж:

```prisma
model sales {
  id             Int       @id @default(autoincrement())
  doc_number     String    @db.VarChar(50)
  doc_date       DateTime  @db.Date
  sale_date      DateTime? @db.Date
  user_id        Int
  client_id      Int
  warehouse_id   Int
  total_amount   Decimal   @db.Decimal(10, 2)
  currency       currency  @default(EUR)
  status         String    @default("draft") @db.VarChar(20)
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  updated_at     DateTime? @default(now()) @db.Timestamp(6)
  invoice_type   String?   @db.VarChar(50)
  invoice_number String    @db.VarChar(50)
  vat_rate       Decimal?  @db.Decimal(5, 2)

  // Связи
  users     users      @relation(fields: [user_id], references: [id])
  client    clients    @relation(fields: [client_id], references: [id])
  warehouse warehouses @relation(fields: [warehouse_id], references: [id])

  @@index([doc_date])
  @@index([client_id])
  @@index([warehouse_id])
  @@index([status])
}
```

### 2.2 Связи с другими моделями
Модель продаж связана с:
- users - пользователь, создавший продажу
- clients - клиент, к которому относится продажа
- warehouses - склад, с которого осуществлена продажа

### 2.3 Индексы
Определены индексы для полей, по которым часто выполняется поиск:
- doc_date
- client_id
- warehouse_id
- status

### 2.4 Отсутствие позиций продажи
В отличие от модели `purchases`, у модели `sales` отсутствует явная связь с позициями продажи (sale_items). Это может быть недостатком текущей реализации, так как не позволяет хранить детализацию проданных товаров.

## 3. Анализ запросов к базе данных

### 3.1 Prisma ORM
Для работы с базой данных используется ORM Prisma, доступ к которой осуществляется через модуль `prismaManager`.

### 3.2 Типы запросов
В контроллерах используются следующие типы запросов:
- `findMany` - для получения списка продаж
- `findFirst` - для получения одной продажи по ID с проверкой прав доступа
- `create` - для создания новой продажи
- `updateMany` - для обновления продажи с проверкой прав доступа
- `deleteMany` - для удаления продажи с проверкой прав доступа

### 3.3 Безопасность запросов
Во всех запросах присутствует фильтрация по `user_id`, что обеспечивает разграничение доступа:
```javascript
where: {
  id: parseInt(id),
  user_id: req.user.id,
}
```

## 4. Проблемы и рекомендации

### 4.1 Отсутствие модели позиций продажи
**Проблема:** В отличие от модели закупок, у продаж отсутствует модель и логика для хранения отдельных позиций продажи.

**Рекомендация:** Добавить модель `sale_items` по аналогии с `purchase_items` и обновить контроллеры для работы с ней.

### 4.2 Отсутствие тестов
**Проблема:** Не удалось найти юнит-тесты для модуля продаж.

**Рекомендация:** Разработать набор юнит-тестов для проверки функциональности контроллеров и маршрутов продаж.

### 4.3 Ограниченная валидация входных данных
**Проблема:** В контроллерах недостаточно валидации входных данных, что может привести к ошибкам или уязвимостям.

**Рекомендация:** Добавить более строгую валидацию входных данных с использованием библиотеки типа Joi или Zod.

### 4.4 Отсутствие пагинации
**Проблема:** Метод `getAllSales` возвращает все продажи пользователя без пагинации, что может привести к проблемам производительности при большом количестве данных.

**Рекомендация:** Добавить параметры пагинации (limit, offset) и фильтрации к методу `getAllSales`.

### 4.5 Обработка транзакций
**Проблема:** При создании новой продажи не используются транзакции Prisma, что может привести к несогласованности данных в случае ошибок.

**Рекомендация:** Использовать `prisma.$transaction` для операций, требующих атомарности.

## 5. Сравнение с модулем закупок

### 5.1 Сходства
- Аналогичная структура API-маршрутов
- Похожая реализация контроллеров
- Идентичный подход к экспорту данных в различные форматы

### 5.2 Различия
- Модуль закупок включает в себя позиции закупок (purchase_items)
- В контроллере закупок реализована транзакционная логика для создания записей
- В модуле закупок поддерживается создание как основного документа, так и его позиций

## 6. Заключение

Бэкенд-компоненты модуля продаж имеют достаточно хорошую структуру и базовую функциональность для работы с продажами. Основные проблемы связаны с отсутствием позиций продажи, недостаточной валидацией входных данных и отсутствием тестов.

Рекомендуется в первую очередь добавить модель и логику для работы с позициями продажи, что сделает модуль более полным и соответствующим бизнес-требованиям.

---

*Документ создан в рамках аудита бэкенд-компонентов модуля продаж SOLAR ERP*